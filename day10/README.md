# Агент сбора реквизитов с тремя стратегиями управления контекстом

## Описание

CLI-агент для сбора реквизитов компании через LLM (OpenAI-совместимый API).
Реализованы три стратегии управления контекстом:

1. **Sliding Window** — храним только последние N сообщений
2. **Sticky Facts** — извлекаем факты (key-value) + последние N сообщений
3. **Branching** — checkpoint'ы и независимые ветки диалога

## Установка

```bash
# Клонируем/копируем файлы
# Зависимостей нет — только стандартная библиотека Python 3.8+

# Устанавливаем переменные окружения
export OPENAI_BASE_URL="https://api.openai.com/v1"
export OPENAI_API_KEY="sk-..."
```

## Использование

### Базовый запуск

```bash
# Sliding Window (по умолчанию)
python main.py --strategy sliding_window --window_size 10

# Sticky Facts
python main.py --strategy sticky_facts --window_size 6

# Branching
python main.py --strategy branching --window_size 20
```

### Параметры

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `--strategy` | Стратегия: `sliding_window`, `sticky_facts`, `branching` | `sliding_window` |
| `--window_size` | Количество сообщений в окне | `10` |
| `--model` | Модель LLM | `gpt-4o-mini` |
| `--max_tokens` | Макс. токенов в ответе | `1024` |
| `--json_format` | Финальный ответ в JSON | `False` |
| `--memory_path` | Путь к файлу состояния | `memory.json` |

### Команды в чате

```
/help           — справка
/info           — информация о стратегии и статистика токенов
/facts          — показать извлечённые факты (только sticky_facts)
/reset          — сбросить диалог

# Только для branching:
/checkpoint <n>               — создать checkpoint
/branch <n> from <checkpoint> — создать ветку от checkpoint
/switch <branch>              — переключиться на ветку
/branches                     — список веток
/checkpoints                  — список checkpoint'ов
```

### Специальный ввод

```
\e          — открыть редактор ($EDITOR) для ввода
@file.txt   — прочитать сообщение из файла
```

---

## Стратегии подробно

### 1. Sliding Window

**Принцип:** Храним только последние N сообщений. Всё старое — отбрасываем.

```
Диалог: [msg1, msg2, msg3, msg4, msg5, msg6, msg7]
Window = 4
В контекст: [msg4, msg5, msg6, msg7]
```

**Плюсы:**
- Простейшая реализация
- Предсказуемый расход токенов

**Минусы:**
- Теряет важную информацию из начала диалога
- Агент может «забыть» ранее сообщённые данные

**Когда использовать:** Короткие сессии, простые Q&A.

---

### 2. Sticky Facts

**Принцип:** 
- Отдельно храним структурированные факты (key-value)
- Факты извлекаются из диалога через LLM после каждого сообщения пользователя
- В контекст идёт: `[system + facts] + [последние N сообщений]`

```python
facts = {
    "full_legal_name": "ООО «Рога и Копыта»",
    "inn": "7712345678",
    "signatory_name": "Иванов Иван Иванович",
    ...
}
```

**Плюсы:**
- Важная информация не теряется
- Экономия токенов — храним суть, не всю болтовню

**Минусы:**
- Дополнительные вызовы LLM для извлечения фактов
- Факты могут извлечься неточно

**Когда использовать:** Сбор данных, долгие консультации, любые сценарии с накапливаемыми решениями.

---

### 3. Branching

**Принцип:**
- Можно создавать checkpoint (точку сохранения)
- От checkpoint создаются независимые ветки
- Каждая ветка живёт своей жизнью
- Можно переключаться между ветками

```
                [checkpoint: "обсудили базу"]
                       /              \
                  ветка A           ветка B
               "Сбербанк"         "Тинькофф"
                    |                  |
              свои сообщения      свои сообщения
```

**Плюсы:**
- Исследование альтернатив без потери основного диалога
- «Что если» сценарии
- A/B сравнение решений

**Минусы:**
- Сложнее в реализации и использовании
- Нужен UI для управления ветками

**Когда использовать:** Планирование с вариантами, креативные задачи, принятие решений с возможностью отката.

---

## Тестирование

### Автоматический тест

```bash
python test_strategies.py
```

Скрипт прогоняет тестовый сценарий (12 сообщений сбора реквизитов) на всех стратегиях и генерирует отчёт `comparison_report.md`.

### Ручное тестирование

Рекомендуемый сценарий для ручного теста:

```
1. Привет, мне нужно заключить договор
2. Компания называется ООО «Рога и Копыта»
3. ИНН 7712345678
4. ОГРН 1177746123456
5. Юридический адрес: 123456, г. Москва, ул. Тверская, д. 1
6. Договор подписывает генеральный директор Иванов Иван Иванович
7. Банк — Сбербанк
8. БИК 044525225
9. Расчётный счёт 40702810938000012345
10. Корреспондентский счёт 30101810400000000225
11. Напомни, какой у нас ИНН и кто подписант?  <-- Проверка памяти!
12. Выведи все реквизиты
```

---

## Сравнение стратегий

| Критерий | Sliding Window | Sticky Facts | Branching |
|----------|---------------|--------------|-----------|
| Сложность | ⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| Сохранение важного | ❌ | ✅ | ✅ (в рамках ветки) |
| Расход токенов | Стабильный | +overhead на факты | Зависит от ветки |
| Exploration | ❌ | ❌ | ✅ |
| Откат решений | ❌ | ❌ | ✅ |

---

## Структура файлов

```
.
├── main.py                 # CLI интерфейс
├── agent.py                # Агент с поддержкой стратегий
├── context_strategies.py   # Реализация трёх стратегий
├── test_strategies.py      # Автоматическое тестирование
├── README.md               # Эта документация
└── memory.json             # Файл состояния (создаётся автоматически)
```

---

## Примеры использования Branching

```bash
# Запускаем с branching
python main.py --strategy branching

# Ведём диалог до точки развилки
> Компания ООО Тест, ИНН 1234567890
> Адрес: Москва, Красная площадь 1
> Подписант директор Петров

# Создаём checkpoint
> /checkpoint before_bank

# Создаём ветку для Сбербанка
> /branch sberbank from before_bank
> /switch sberbank
> Банк Сбербанк, БИК 044525225

# Создаём ветку для Тинькофф
> /branch tinkoff from before_bank
> /switch tinkoff
> Банк Тинькофф, БИК 044525974

# Переключаемся обратно
> /switch sberbank
> Покажи реквизиты  # Будут со Сбербанком

> /switch tinkoff
> Покажи реквизиты  # Будут с Тинькофф
```

---

## Формат memory.json

### Sliding Window
```json
{
  "strategy": "sliding_window",
  "window_size": 10,
  "messages": [...],
  "full_history": [...]
}
```

### Sticky Facts
```json
{
  "strategy": "sticky_facts",
  "window_size": 6,
  "facts": {
    "full_legal_name": "...",
    "inn": "...",
    ...
  },
  "messages": [...],
  "full_history": [...]
}
```

### Branching
```json
{
  "strategy": "branching",
  "current_branch": "main",
  "checkpoints": {
    "cp1": {"name": "cp1", "messages": [...]}
  },
  "branches": {
    "main": {"name": "main", "messages": [...]},
    "branch_a": {"name": "branch_a", "messages": [...]}
  }
}
```
